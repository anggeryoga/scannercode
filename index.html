<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoScan - Barcode Scanner & Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/zxing-js@0.19.1/library.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        :root {
            --primary: #000000;
            --secondary: #ffffff;
            --accent: #ff4d4d;
            --bg: #f5f5f5;
            --card: #ffffff;
            --text: #000000;
            --border-radius: 8px;
            --shadow: 8px 8px 0px 0px var(--primary);
        }

        .dark {
            --primary: #ffffff;
            --secondary: #000000;
            --accent: #ff4d4d;
            --bg: #121212;
            --card: #1e1e1e;
            --text: #ffffff;
            --shadow: 8px 8px 0px 0px var(--primary);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            transition: all 0.3s ease;
        }

        .neobrutal-card {
            background-color: var(--card);
            border: 3px solid var(--primary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .neobrutal-btn {
            background-color: var(--secondary);
            color: var(--primary);
            border: 3px solid var(--primary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            font-weight: bold;
        }

        .neobrutal-btn:hover {
            transform: translate(2px, 2px);
            box-shadow: 6px 6px 0px 0px var(--primary);
        }

        .neobrutal-btn:active {
            transform: translate(4px, 4px);
            box-shadow: 4px 4px 0px 0px var(--primary);
        }

        .neobrutal-btn-accent {
            background-color: var(--accent);
            color: var(--secondary);
        }

        .neobrutal-input {
            background-color: var(--secondary);
            border: 3px solid var(--primary);
            border-radius: var(--border-radius);
            padding: 0.75rem;
            box-shadow: 4px 4px 0px 0px var(--primary);
        }

        .neobrutal-input:focus {
            outline: none;
            box-shadow: 6px 6px 0px 0px var(--primary);
        }

        .neobrutal-tab {
            border-bottom: 3px solid var(--primary);
        }

        .neobrutal-tab.active {
            border-bottom: 3px solid var(--accent);
            font-weight: bold;
        }

        .scanning-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 15px solid rgba(0, 0, 0, 0.3);
            box-sizing: border-box;
            pointer-events: none;
        }

        .scanning-line {
            position: absolute;
            width: 100%;
            height: 3px;
            background-color: var(--accent);
            animation: scanning 2s infinite linear;
        }

        @keyframes scanning {
            0% { top: 0; }
            100% { top: 100%; }
        }

        .success-pulse {
            animation: successPulse 0.5s;
        }

        @keyframes successPulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }

        .dropzone {
            border: 3px dashed var(--primary);
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
        }

        .dropzone.active {
            border-color: var(--accent);
            background-color: rgba(255, 77, 77, 0.1);
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-black mr-4"></div>
                <h1 class="text-3xl font-bold">NeoScan</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="languageToggle" class="neobrutal-btn px-4 py-2">EN/ID</button>
                <button id="themeToggle" class="neobrutal-btn px-4 py-2">
                    <span class="dark:hidden">üåô</span>
                    <span class="hidden dark:inline">‚òÄÔ∏è</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Tabs Navigation -->
            <div class="flex mb-8 overflow-x-auto">
                <button data-tab="generator" class="neobrutal-tab px-6 py-3 text-lg active">Generator</button>
                <button data-tab="scanner" class="neobrutal-tab px-6 py-3 text-lg">Live Scanner</button>
                <button data-tab="upload" class="neobrutal-tab px-6 py-3 text-lg">Image Scanner</button>
                <button data-tab="history" class="neobrutal-tab px-6 py-3 text-lg">History</button>
            </div>

            <!-- Tab Contents -->
            <div class="neobrutal-card p-6 mb-8">
                <!-- Generator Tab -->
                <div id="generator" class="tab-content active">
                    <h2 class="text-2xl font-bold mb-6">Barcode Generator</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <div class="mb-6">
                                <label class="block mb-2 font-bold">Barcode Type</label>
                                <select id="barcodeType" class="neobrutal-input w-full">
                                    <option value="CODE128">CODE128</option>
                                    <option value="QR">QR Code</option>
                                    <option value="EAN13">EAN-13</option>
                                    <option value="UPC">UPC-A</option>
                                    <option value="CODE39">CODE39</option>
                                    <option value="ITF14">ITF-14</option>
                                    <option value="MSI">MSI</option>
                                    <option value="pharmacode">Pharmacode</option>
                                </select>
                            </div>

                            <div class="mb-6">
                                <label class="block mb-2 font-bold">Content</label>
                                <input id="barcodeContent" type="text" class="neobrutal-input w-full" placeholder="Enter text or numbers">
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label class="block mb-2 font-bold">Width</label>
                                    <input id="barcodeWidth" type="range" min="1" max="5" step="0.1" value="2" class="w-full">
                                    <span id="widthValue" class="text-sm">2</span>
                                </div>
                                <div>
                                    <label class="block mb-2 font-bold">Height</label>
                                    <input id="barcodeHeight" type="range" min="20" max="200" value="100" class="w-full">
                                    <span id="heightValue" class="text-sm">100</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label class="block mb-2 font-bold">Line Color</label>
                                    <input id="lineColor" type="color" value="#000000" class="w-full h-10">
                                </div>
                                <div>
                                    <label class="block mb-2 font-bold">Background</label>
                                    <input id="bgColor" type="color" value="#ffffff" class="w-full h-10">
                                </div>
                            </div>

                            <div class="mb-6">
                                <label class="block mb-2 font-bold">Display Text</label>
                                <select id="displayText" class="neobrutal-input w-full">
                                    <option value="true">Show</option>
                                    <option value="false">Hide</option>
                                </select>
                            </div>

                            <button id="generateBtn" class="neobrutal-btn neobrutal-btn-accent px-6 py-3">Generate Barcode</button>
                        </div>

                        <div class="flex flex-col items-center justify-center">
                            <div id="barcodePreview" class="mb-6 p-4 bg-white border-2 border-black">
                                <p class="text-center">Preview will appear here</p>
                            </div>
                            <div class="flex space-x-4">
                                <button id="downloadPNG" class="neobrutal-btn px-4 py-2">PNG</button>
                                <button id="downloadSVG" class="neobrutal-btn px-4 py-2">SVG</button>
                                <button id="downloadPDF" class="neobrutal-btn px-4 py-2">PDF</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scanner Tab -->
                <div id="scanner" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">Live Barcode Scanner</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <div class="mb-6">
                                <label class="block mb-2 font-bold">Camera</label>
                                <select id="cameraSelect" class="neobrutal-input w-full">
                                    <option value="environment">Back Camera</option>
                                    <option value="user">Front Camera</option>
                                </select>
                            </div>

                            <div class="mb-6">
                                <label class="block mb-2 font-bold">Scan Mode</label>
                                <select id="scanMode" class="neobrutal-input w-full">
                                    <option value="single">Single Scan</option>
                                    <option value="continuous">Continuous Scan</option>
                                    <option value="batch">Batch Mode</option>
                                </select>
                            </div>

                            <div class="mb-6">
                                <label class="block mb-2 font-bold">Barcode Formats</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <label><input type="checkbox" name="format" value="QR_CODE" checked> QR Code</label>
                                    <label><input type="checkbox" name="format" value="CODE_128" checked> CODE128</label>
                                    <label><input type="checkbox" name="format" value="EAN_13" checked> EAN-13</label>
                                    <label><input type="checkbox" name="format" value="UPC_A" checked> UPC-A</label>
                                    <label><input type="checkbox" name="format" value="CODE_39" checked> CODE39</label>
                                    <label><input type="checkbox" name="format" value="ITF" checked> ITF</label>
                                </div>
                            </div>

                            <div class="flex space-x-4">
                                <button id="startScan" class="neobrutal-btn neobrutal-btn-accent px-6 py-3">Start Scanning</button>
                                <button id="stopScan" class="neobrutal-btn px-6 py-3" disabled>Stop</button>
                            </div>
                        </div>

                        <div>
                            <div class="relative">
                                <video id="scannerVideo" class="w-full h-auto border-2 border-black" playsinline></video>
                                <div id="scanningOverlay" class="scanning-overlay hidden">
                                    <div class="scanning-line"></div>
                                </div>
                            </div>
                            <div id="scanResult" class="mt-4 p-4 neobrutal-card hidden">
                                <h3 class="font-bold mb-2">Scan Result</h3>
                                <p id="scannedContent" class="mb-2"></p>
                                <p id="scannedFormat" class="text-sm opacity-75"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Tab -->
                <div id="upload" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">Image Barcode Scanner</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <div id="dropzone" class="dropzone p-12 mb-6 text-center cursor-pointer">
                                <p class="mb-4">Drag & drop your image here</p>
                                <p class="text-sm opacity-75 mb-4">or</p>
                                <button id="uploadBtn" class="neobrutal-btn px-4 py-2">Select File</button>
                                <input type="file" id="fileInput" accept="image/*" class="hidden">
                            </div>

                            <div class="mb-6 hidden" id="imageControls">
                                <label class="block mb-2 font-bold">Image Adjustments</label>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block mb-1">Brightness</label>
                                        <input type="range" id="brightness" min="0" max="200" value="100" class="w-full">
                                    </div>
                                    <div>
                                        <label class="block mb-1">Contrast</label>
                                        <input type="range" id="contrast" min="0" max="200" value="100" class="w-full">
                                    </div>
                                </div>
                                <div class="flex space-x-4">
                                    <button id="rotateLeft" class="neobrutal-btn px-4 py-2">‚Ü∫ Rotate Left</button>
                                    <button id="rotateRight" class="neobrutal-btn px-4 py-2">‚Üª Rotate Right</button>
                                </div>
                            </div>

                            <button id="scanImageBtn" class="neobrutal-btn neobrutal-btn-accent px-6 py-3 hidden">Scan Image</button>
                        </div>

                        <div>
                            <div class="mb-4">
                                <canvas id="imageCanvas" class="w-full h-auto border-2 border-black hidden"></canvas>
                            </div>
                            <div id="imageScanResult" class="neobrutal-card p-4 hidden">
                                <h3 class="font-bold mb-2">Scan Results</h3>
                                <div id="imageResultsList" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div id="history" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">Scan History</h2>
                    <div class="flex justify-between mb-6">
                        <div class="flex items-center space-x-4">
                            <div class="neobrutal-card px-4 py-2">
                                <span class="text-sm">Total Scans:</span>
                                <span id="totalScans" class="font-bold ml-2">0</span>
                            </div>
                            <div class="neobrutal-card px-4 py-2">
                                <span class="text-sm">Today:</span>
                                <span id="todayScans" class="font-bold ml-2">0</span>
                            </div>
                        </div>
                        <div>
                            <button id="exportCSV" class="neobrutal-btn px-4 py-2 mr-2">CSV</button>
                            <button id="exportExcel" class="neobrutal-btn px-4 py-2">Excel</button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b-2 border-black">
                                    <th class="text-left py-2">Date</th>
                                    <th class="text-left py-2">Content</th>
                                    <th class="text-left py-2">Format</th>
                                    <th class="text-left py-2">Source</th>
                                    <th class="text-left py-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable">
                                <!-- History items will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center py-6 text-sm opacity-75">
            <p>NeoScan - All-in-One Barcode Scanner & Generator</p>
            <p class="mt-1">¬© 2023 NeoScan. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const tabButtons = document.querySelectorAll('[data-tab]');
        const tabContents = document.querySelectorAll('.tab-content');
        const themeToggle = document.getElementById('themeToggle');
        const languageToggle = document.getElementById('languageToggle');

        // Generator Elements
        const barcodeType = document.getElementById('barcodeType');
        const barcodeContent = document.getElementById('barcodeContent');
        const barcodeWidth = document.getElementById('barcodeWidth');
        const barcodeHeight = document.getElementById('barcodeHeight');
        const widthValue = document.getElementById('widthValue');
        const heightValue = document.getElementById('heightValue');
        const lineColor = document.getElementById('lineColor');
        const bgColor = document.getElementById('bgColor');
        const displayText = document.getElementById('displayText');
        const generateBtn = document.getElementById('generateBtn');
        const barcodePreview = document.getElementById('barcodePreview');
        const downloadPNG = document.getElementById('downloadPNG');
        const downloadSVG = document.getElementById('downloadSVG');
        const downloadPDF = document.getElementById('downloadPDF');

        // Scanner Elements
        const cameraSelect = document.getElementById('cameraSelect');
        const scanMode = document.getElementById('scanMode');
        const startScan = document.getElementById('startScan');
        const stopScan = document.getElementById('stopScan');
        const scannerVideo = document.getElementById('scannerVideo');
        const scanningOverlay = document.getElementById('scanningOverlay');
        const scanResult = document.getElementById('scanResult');
        const scannedContent = document.getElementById('scannedContent');
        const scannedFormat = document.getElementById('scannedFormat');

        // Upload Elements
        const dropzone = document.getElementById('dropzone');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const imageControls = document.getElementById('imageControls');
        const scanImageBtn = document.getElementById('scanImageBtn');
        const imageCanvas = document.getElementById('imageCanvas');
        const imageScanResult = document.getElementById('imageScanResult');
        const imageResultsList = document.getElementById('imageResultsList');
        const brightness = document.getElementById('brightness');
        const contrast = document.getElementById('contrast');
        const rotateLeft = document.getElementById('rotateLeft');
        const rotateRight = document.getElementById('rotateRight');

        // History Elements
        const totalScans = document.getElementById('totalScans');
        const todayScans = document.getElementById('todayScans');
        const exportCSV = document.getElementById('exportCSV');
        const exportExcel = document.getElementById('exportExcel');
        const historyTable = document.getElementById('historyTable');

        // Global Variables
        let currentTab = 'generator';
        let isDarkMode = false;
        let isEnglish = true;
        let scanHistory = JSON.parse(localStorage.getItem('scanHistory')) || [];
        let stream = null;
        let currentRotation = 0;
        let selectedImage = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateHistoryDisplay();
            updateStats();
            
            // Set up barcode content live preview
            barcodeContent.addEventListener('input', updateBarcodePreview);
            
            // Set up range value displays
            barcodeWidth.addEventListener('input', () => {
                widthValue.textContent = barcodeWidth.value;
                updateBarcodePreview();
            });
            
            barcodeHeight.addEventListener('input', () => {
                heightValue.textContent = barcodeHeight.value;
                updateBarcodePreview();
            });
            
            // Set up color change listeners
            lineColor.addEventListener('change', updateBarcodePreview);
            bgColor.addEventListener('change', updateBarcodePreview);
            displayText.addEventListener('change', updateBarcodePreview);
            
            // Initial preview update
            updateBarcodePreview();
        });

        // Tab Switching
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');
                switchTab(tabId);
            });
        });

        function switchTab(tabId) {
            // Update active tab button
            tabButtons.forEach(button => {
                if (button.getAttribute('data-tab') === tabId) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            // Update active tab content
            tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.add('active');
                    content.classList.remove('hidden');
                } else {
                    content.classList.remove('active');
                    content.classList.add('hidden');
                }
            });
            
            // Stop scanner when switching away from scanner tab
            if (currentTab === 'scanner' && tabId !== 'scanner') {
                stopScanner();
            }
            
            currentTab = tabId;
            
            // Special handling for certain tabs
            if (tabId === 'history') {
                updateHistoryDisplay();
            }
        }

        // Theme Toggle
        themeToggle.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Language Toggle
        languageToggle.addEventListener('click', () => {
            isEnglish = !isEnglish;
            // In a real app, we would update all text content here
            languageToggle.textContent = isEnglish ? 'EN/ID' : 'ID/EN';
        });

        // Barcode Generator Functions
        function updateBarcodePreview() {
            const content = barcodeContent.value || 'PREVIEW';
            const type = barcodeType.value;
            const width = parseFloat(barcodeWidth.value);
            const height = parseInt(barcodeHeight.value);
            const lineColorValue = lineColor.value;
            const bgColorValue = bgColor.value;
            const showText = displayText.value === 'true';
            
            try {
                barcodePreview.innerHTML = '';
                
                if (type === 'QR') {
                    // Generate QR code
                    QRCode.toCanvas(content, {
                        width: 200,
                        color: {
                            dark: lineColorValue,
                            light: bgColorValue
                        }
                    }, (err, canvas) => {
                        if (err) throw err;
                        canvas.style.width = '100%';
                        canvas.style.height = 'auto';
                        barcodePreview.appendChild(canvas);
                    });
                } else {
                    // Generate other barcode types
                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    JsBarcode(svg, content, {
                        format: type,
                        width: width,
                        height: height,
                        lineColor: lineColorValue,
                        background: bgColorValue,
                        displayValue: showText,
                        margin: 10
                    });
                    barcodePreview.innerHTML = '';
                    barcodePreview.appendChild(svg);
                }
            } catch (e) {
                barcodePreview.innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`;
            }
        }

        function generateBarcode() {
            updateBarcodePreview();
            
            // In a real app, we would implement the download functionality
            // For now, we'll just show a success message
            barcodePreview.classList.add('success-pulse');
            setTimeout(() => {
                barcodePreview.classList.remove('success-pulse');
            }, 500);
        }

        // Scanner Functions
        async function startScanner() {
            try {
                const constraints = {
                    video: {
                        facingMode: cameraSelect.value,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                scannerVideo.srcObject = stream;
                scannerVideo.play();
                
                startScan.disabled = true;
                stopScan.disabled = false;
                scanningOverlay.classList.remove('hidden');
                
                // Start barcode detection
                detectBarcode();
            } catch (err) {
                console.error('Error accessing camera:', err);
                alert(`Camera error: ${err.message}`);
            }
        }

        function stopScanner() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                scannerVideo.srcObject = null;
                stream = null;
            }
            
            startScan.disabled = false;
            stopScan.disabled = true;
            scanningOverlay.classList.add('hidden');
        }

        function detectBarcode() {
            if (!stream) return;
            
            const codeReader = new ZXing.BrowserMultiFormatReader();
            const video = scannerVideo;
            
            function scanLoop() {
                if (!stream) return;
                
                codeReader.decodeFromVideoElement(video)
                    .then(result => {
                        if (result) {
                            handleScanResult(result.text, result.format);
                            
                            if (scanMode.value === 'single') {
                                stopScanner();
                            }
                        }
                        
                        if (stream) {
                            requestAnimationFrame(scanLoop);
                        }
                    })
                    .catch(err => {
                        if (stream) {
                            requestAnimationFrame(scanLoop);
                        }
                    });
            }
            
            scanLoop();
        }

        function handleScanResult(content, format) {
            // Format the format string for display
            const formatDisplay = format.replace(/_/g, '-');
            
            // Update UI
            scannedContent.textContent = content;
            scannedFormat.textContent = formatDisplay;
            scanResult.classList.remove('hidden');
            scanResult.classList.add('success-pulse');
            
            setTimeout(() => {
                scanResult.classList.remove('success-pulse');
            }, 500);
            
            // Add to history
            addToHistory(content, formatDisplay, 'camera');
        }

        // Image Scanner Functions
        function setupDropzone() {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropzone.classList.add('active');
            }
            
            function unhighlight() {
                dropzone.classList.remove('active');
            }
            
            dropzone.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }
            
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length) {
                    handleFiles(fileInput.files);
                }
            });
        }

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (file.type.match('image.*')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        selectedImage = new Image();
                        selectedImage.onload = function() {
                            displayImageOnCanvas(selectedImage);
                            imageControls.classList.remove('hidden');
                            scanImageBtn.classList.remove('hidden');
                        };
                        selectedImage.src = e.target.result;
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
        }

        function displayImageOnCanvas(img) {
            const canvas = imageCanvas;
            const ctx = canvas.getContext('2d');
            
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            canvas.classList.remove('hidden');
            applyImageAdjustments();
        }

        function applyImageAdjustments() {
            if (!selectedImage) return;
            
            const canvas = imageCanvas;
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            
            // Apply rotation
            if (currentRotation !== 0) {
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(currentRotation * Math.PI / 180);
                
                if (currentRotation === 90 || currentRotation === 270) {
                    ctx.drawImage(selectedImage, -selectedImage.height / 2, -selectedImage.width / 2);
                } else {
                    ctx.drawImage(selectedImage, -selectedImage.width / 2, -selectedImage.height / 2);
                }
                
                ctx.restore();
            } else {
                ctx.drawImage(selectedImage, 0, 0);
            }
            
            // Apply brightness and contrast
            const brightnessValue = parseInt(brightness.value) / 100;
            const contrastValue = parseInt(contrast.value) / 100;
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Apply brightness and contrast to each pixel
            for (let i = 0; i < data.length; i += 4) {
                // Brightness
                data[i] = data[i] * brightnessValue;
                data[i+1] = data[i+1] * brightnessValue;
                data[i+2] = data[i+2] * brightnessValue;
                
                // Contrast
                const factor = (259 * (contrastValue + 255)) / (255 * (259 - contrastValue));
                data[i] = factor * (data[i] - 128) + 128;
                data[i+1] = factor * (data[i+1] - 128) + 128;
                data[i+2] = factor * (data[i+2] - 128) + 128;
            }
            
            ctx.putImageData(imageData, 0, 0);
        }

        function scanImage() {
            if (!selectedImage) return;
            
            const codeReader = new ZXing.BrowserMultiFormatReader();
            const canvas = imageCanvas;
            
            codeReader.decodeFromCanvas(canvas)
                .then(result => {
                    if (result) {
                        const formatDisplay = result.format.replace(/_/g, '-');
                        addToHistory(result.text, formatDisplay, 'image');
                        
                        // Display results
                        imageResultsList.innerHTML = `
                            <div class="p-3 neobrutal-card">
                                <p class="font-bold">${result.text}</p>
                                <p class="text-sm opacity-75">${formatDisplay}</p>
                            </div>
                        `;
                        
                        imageScanResult.classList.remove('hidden');
                        imageScanResult.classList.add('success-pulse');
                        
                        setTimeout(() => {
                            imageScanResult.classList.remove('success-pulse');
                        }, 500);
                    } else {
                        imageResultsList.innerHTML = '<p class="text-red-500">No barcode detected in the image.</p>';
                        imageScanResult.classList.remove('hidden');
                    }
                })
                .catch(err => {
                    imageResultsList.innerHTML = `<p class="text-red-500">Error: ${err.message}</p>`;
                    imageScanResult.classList.remove('hidden');
                });
        }

        // History Functions
        function addToHistory(content, format, source) {
            const now = new Date();
            const timestamp = now.toISOString();
            
            const entry = {
                timestamp,
                content,
                format,
                source,
                note: ''
            };
            
            scanHistory.unshift(entry);
            localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
            
            updateStats();
            
            if (currentTab === 'history') {
                updateHistoryDisplay();
            }
        }

        function updateHistoryDisplay() {
            historyTable.innerHTML = '';
            
            if (scanHistory.length === 0) {
                historyTable.innerHTML = `
                    <tr>
                        <td colspan="5" class="py-4 text-center">No scan history yet</td>
                    </tr>
                `;
                return;
            }
            
            scanHistory.forEach((entry, index) => {
                const date = new Date(entry.timestamp);
                const dateStr = date.toLocaleString();
                
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200';
                row.innerHTML = `
                    <td class="py-3">${dateStr}</td>
                    <td class="py-3">${entry.content}</td>
                    <td class="py-3">${entry.format}</td>
                    <td class="py-3">${entry.source}</td>
                    <td class="py-3">
                        <button class="neobrutal-btn px-2 py-1 text-sm" onclick="showNoteModal(${index})">‚úèÔ∏è</button>
                        <button class="neobrutal-btn px-2 py-1 text-sm" onclick="deleteHistoryItem(${index})">üóëÔ∏è</button>
                    </td>
                `;
                
                historyTable.appendChild(row);
            });
        }

        function updateStats() {
            totalScans.textContent = scanHistory.length;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayCount = scanHistory.filter(entry => {
                const entryDate = new Date(entry.timestamp);
                return entryDate >= today;
            }).length;
            
            todayScans.textContent = todayCount;
        }

        // Event Listeners
        generateBtn.addEventListener('click', generateBarcode);
        
        startScan.addEventListener('click', startScanner);
        stopScan.addEventListener('click', stopScanner);
        
        rotateLeft.addEventListener('click', () => {
            currentRotation = (currentRotation - 90) % 360;
            applyImageAdjustments();
        });
        
        rotateRight.addEventListener('click', () => {
            currentRotation = (currentRotation + 90) % 360;
            applyImageAdjustments();
        });
        
        brightness.addEventListener('input', applyImageAdjustments);
        contrast.addEventListener('input', applyImageAdjustments);
        
        scanImageBtn.addEventListener('click', scanImage);
        
        // Setup dropzone
        setupDropzone();

        // Global functions for history actions
        window.showNoteModal = function(index) {
            // In a real app, we would show a modal to edit the note
            const note = prompt('Add a note to this scan:', scanHistory[index].note || '');
            if (note !== null) {
                scanHistory[index].note = note;
                localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
                updateHistoryDisplay();
            }
        };

        window.deleteHistoryItem = function(index) {
            if (confirm('Are you sure you want to delete this scan from history?')) {
                scanHistory.splice(index, 1);
                localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
                updateHistoryDisplay();
                updateStats();
            }
        };
    </script>
</body>
</html>
